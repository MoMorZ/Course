/* TCPClient.cpp */

#include <stdlib.h>
#include <stdio.h>
#include <winsock2.h>
#include <string.h>

#define BUFLEN 2000                // ????????§³
#define WSVERS MAKEWORD(2, 0)      // ????·Ú2.0
#pragma comment(lib, "ws2_32.lib") // ???winsock 2.0 Llibrary

/*------------------------------------------------------------------------
 * main - TCP client for TIME service
 *------------------------------------------------------------------------
 */
int main()
{
    const char *host = "127.0.0.1"; /* server IP to connect         */
    const char *service = "50500";  /* server port to connect       */
    struct sockaddr_in sin;         /* an Internet endpoint address	*/
    char buf[BUFLEN + 1];           /* buffer for one line of text	*/
    SOCKET sock;                    /* socket descriptor	    	*/
    int cc;                         /* recv character count		    */
    char filepath[100], *filename;
    int filelen;
    FILE *fp;

    while (1)
    {
        WSADATA wsadata;
        WSAStartup(WSVERS, &wsadata); //????winsock library??WSVERS??????·Ú??wsadata????????????????·Ú

        sock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP); //??????????????????????§¿???(family)??????????TCP§¿??
        //????????????????????????INVALID_SOCKET

        memset(&sin, 0, sizeof(sin));                                  // ??&sin?????????sizeof(sin)???????0
        sin.sin_family = AF_INET;                                      // ???????????
        sin.sin_addr.s_addr = inet_addr(host);                         // ???¡Â?????IP???(32¦Ë)
        sin.sin_port = htons((u_short)atoi(service));                  // ???¡Â?????????
        int ret = connect(sock, (struct sockaddr *)&sin, sizeof(sin)); // ?????????????????????????????????????????????????????????§³????????0?????????????????SOCKET_ERROR???????????¨®???????WSAGetLastError()?????????????
        if (ret == -1)
        {
            printf("???????!\n");
        }
        else
        {
            printf("??????!\n");
            printf("?????????¡¤??:\n");
            scanf("%s", filepath);
            if (strcmp(filepath, "exit") == 0)
                break;

            filename = strrchr(filepath, '\\');
            if (filename)
                send(sock, filename + 1, strlen(filename) + 1, 0);
            else
                send(sock, filepath, strlen(filepath) + 1, 0);

            fp = fopen(filepath, "rb");
            while ((filelen = fread(buf, sizeof(char), BUFLEN, fp)) > 0)
                send(sock, buf, filelen, 0);
            fclose(fp);
            shutdown(sock, SD_SEND);

            cc = recv(sock, buf, BUFLEN, 0);
            if (cc > 0)
            {
                buf[cc] = '\0';
                printf("%s\n", buf);
            }
            else if (cc == 0)
            {
                printf("?????????!\n");
            }
            else
            {
                printf("????: %ld\n", GetLastError());
            }
        }
    }
    closesocket(sock); // ???????????
    WSACleanup();      // §Ø??winsock library
    printf("?????????!\n");
    printf("???????????...");
    getchar(); // ?????????
    getchar();
    return 0;
}
